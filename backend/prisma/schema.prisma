// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// ‚úÖ ENUMS
enum UserStatus {
  ACTIVE
  BLOCKED
}

enum Gender {
   MALE
   FEMALE
   OTHER
}

enum SessionStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

enum OTPVerificationStatus {
  PENDING
  VERIFIED
  EXPIRED
}


enum ProfessionStatus {
  ACTIVE
  INACTIVE
}


enum CategoryType {
  INCOME
  EXPENSE
  SAVING
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  FAILED
}


enum TransactionType {
  INCOME
  EXPENSE
  GOAL_DEPOSIT
  GOAL_WITHDRAW
}

enum NotificationType {
  ALERT          // Urgent or critical notifications
  INFO           // Informational messages (e.g., "New feature available")
  SUCCESS        // Positive confirmations (e.g., "Goal completed successfully")
  WARNING        // Potential issues (e.g., "Balance low")
}

enum BalanceUpdateType {
  SPENDABLE
  SAVING
}

enum BalanceUpdateResource {
  USER_ADJUSTMENT 
  TRANSACTION
  GOAL_DEPOSIT
  GOAL_WITHDRAW
}

// ‚úÖ MODELS

model User {
  id                Int            @id @default(autoincrement())
  profile           UserProfile?
  auth_info         AuthInfo?
  sessions          Session[]
  status            UserStatus     @default(ACTIVE)
  isSetupComplete   Boolean        @default(false)
  isDeleted         Boolean        @default(false)
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt

  @@map("users")
}


model AuthInfo {
  user_id              Int          @id
  email                String       @unique
  password             String
  password_changed_at  DateTime?
  user                 User         @relation(fields: [user_id], references: [id])

  @@map("auth_info")
}


model UserProfile {
  user_id          Int           @id
  name             String        @db.VarChar(20)
  gender Gender
  avatar Avatar  @relation(fields: [avatar_id], references: [id])
  profession       Profession     @relation(fields: [profession_id], references: [id])
  country          Country        @relation(fields: [country_id], references: [id])
  
  profile_picture  String?        @db.VarChar(255)
  
  wallet           Wallet?
  settings         UserSetting?

  //  Foreign Keys
  avatar_id        Int
  profession_id    Int
  country_id       Int
  
  
  // Other relations
  categories Category[]
  goals Goal[]
  transactions Transaction[]
  user             User           @relation(fields: [user_id], references: [id])

  @@map("user_profiles")
}


model Session {
  id          String            @id @default(cuid())
  user_id     Int
  device_name String          @db.VarChar(30)
  address     String
  ip          String
  token       String
  expires_at  DateTime
  status      SessionStatus   @default(ACTIVE)
  created_at   DateTime        @default(now())
  updated_at   DateTime        @updatedAt

  user        User            @relation(fields: [user_id], references: [id])
  @@map("sessions")
}


model Wallet {
  id                 Int           @id @default(autoincrement())
  user_id            Int @unique
  total_balance      Float           @default(0)
  spendable_balance  Float          @default(0)
  saving_balance     Float          @default(0)
  
  

  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  user               UserProfile   @relation(fields: [user_id], references: [user_id])
  @@map("wallets")
}


model UserSetting {
  id                           Int      @id @default(autoincrement())
  user_id                      Int      @unique

  auto_saving                  Boolean  @default(false)
  balance_expense_income_alert Boolean  @default(true)
  email_alerts                 Boolean  @default(true)
  sms_alerts                   Boolean  @default(false)
  transaction_updates          Boolean  @default(true)
  two_factor_auth Boolean @default(false)

  monthly_budget     Float      @default(0)

  currency_id        Int
  currency           Currency      @relation(fields: [currency_id], references: [id])

  created_at                    DateTime @default(now())
  updated_at                    DateTime @updatedAt

  user                         UserProfile     @relation(fields: [user_id], references: [user_id])
  
  @@map("user_settings")
}


model UserInit {
  id               String             @id @default(cuid())
  email            String            
  password         String
  device_name String
  address String
  ip String
  isVerified       Boolean            @default(false)
  verification_id  String
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt


  @@map("user_inits")

  
}


model OtpVerification {
  id          String                  @id @default(cuid())
  codes       OtpCodes[]
  expires_at   DateTime
  status      OTPVerificationStatus   @default(PENDING)
  created_at   DateTime                @default(now())
  updated_at   DateTime                @updatedAt
  @@map("otp_verifications")
}


model OtpCodes {
  id               Int              @id @default(autoincrement())
  verification_id  String
  code             String           @db.Char(4)
  created_at        DateTime         @default(now())

  verification     OtpVerification  @relation(fields: [verification_id], references: [id])

  @@map("otp_codes")
}



model Profession {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(50) @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users UserProfile[]
  @@map("professions")
}



model Country {
  id        Int     @id @default(autoincrement())
  name      String  @db.VarChar(100) @unique
  code String
  flag_code String?
  flag_png String
  flag_svg String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users UserProfile[]
  @@map("countries")
}

model Currency {
  id              Int             @id @default(autoincrement())
  code            String          @unique             // e.g. "USD", "EUR"
  name            String                              // e.g. "US Dollar"
  symbol          String          @db.VarChar(10)      // e.g. "$", "‡ß≥", "‚Ç±"

  // üîó Relations
  user_settings        UserSetting[]                 // user-specific preferences
  main_currencies_tx       Transaction[] @relation("MainCurrency")       // transactions using this as main/base currency
  base_currencies_tx  Transaction[] @relation("BaseCurrency")  // transactions using this as converted currency

  @@map("currencies")
}



model Avatar {
  id  Int     @id @default(autoincrement())
  name String
  src String
  is_default Boolean 
  users UserProfile[]
  @@map("avatars")
}


model Category {
  id          Int            @id @default(autoincrement())
  user_id     Int
  name        String
  type        CategoryType
  icon        String?
  color       String?
  description String @db.VarChar(500)

  is_default  Boolean        @default(false)
  is_deleted  Boolean        @default(false)
  is_hidden Boolean @default(false)
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  
  user        UserProfile    @relation(fields: [user_id], references: [user_id])
  transactions Transaction[]
  @@unique([user_id,name,type])
  @@map("categories")
}



model Goal {
  id          Int            @id @default(autoincrement())
  user_id     Int
  title String @db.VarChar(100)
  target_amount Float
  current_amount Float
  initial_amount Float @default(0)
  deadline DateTime
  complete_percentage Float @default(0)
  status GoalStatus @default(ACTIVE)
  is_withdrawn  Boolean @default(false)
  created_at   DateTime                @default(now())
  updated_at   DateTime                @updatedAt

  user   UserProfile    @relation(fields: [user_id], references: [user_id])
  @@map("goals")
}
model Transaction {
  id   String @id @default(cuid())

  // üîó Relations
  user               UserProfile   @relation(fields: [user_id], references: [user_id])
  category           Category      @relation(fields: [category_id], references: [id])
  currency           Currency      @relation("MainCurrency", fields: [currency_id], references: [id])
  base_currency      Currency?     @relation("BaseCurrency", fields: [base_currency_id], references: [id])

  // üí∞ Financial Fields
  amount             Float
  conversion_rate    Float?
  conversion_amount  Float?

  // ‚öôÔ∏è Metadata
  type               TransactionType
  note               String?
  date               DateTime
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt

  // üîë Foreign Keys
  user_id            Int
  category_id        Int
  currency_id        Int
  base_currency_id   Int?

  @@map("transactions")
}


model Notification {
  id                 Int           @id @default(autoincrement())
  user_id Int

  message String @db.VarChar(100)
  type NotificationType
  is_read Boolean @default(false)

  created_at   DateTime                @default(now())
  updated_at   DateTime                @updatedAt
  @@map("notifications")
}

model BalanceUpdate {
  id   String @id @default(cuid())
  user_id          Int
  reason           String    @db.VarChar(150) // increased length for longer reasons
  prev_balance     Float
  new_balance      Float     // clearer naming: "new" instead of "update"
  change_amount    Float     // optional: makes it easy to see delta (new - prev)
  balance_type BalanceUpdateType
  resource BalanceUpdateResource
  
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  
  @@map("balance_updates")
}
